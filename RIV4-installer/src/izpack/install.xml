<installation version="5.0"
	xmlns:izpack="http://izpack.org/schema/installation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://izpack.org/schema/installation http://izpack.org/schema/5.0/izpack-installation-5.0.xsd">

	<variables>
		<variable name="INSTALL_GROUP" value="NewInstall"/>
 		<variable name="InstallationGroupPanel.sortKey.NewInstall" value="C"/>
   		<variable name="InstallationGroupPanel.sortKey.Upgrade" value="A"/>
   		<variable name="InstallationGroupPanel.sortKey.UpgradeAddsUser" value="B"/>
   		<variable name="TargetPanel.dir.windows" value="${DEFAULT_INSTALL_PATH}4"/>
   		<variable name="DesktopShortcutCheckboxEnabled" value="true"/>
   		<variable name="ShowCreateDirectoryMessage" value="false" />
	</variables>
	<info>
		<appname>RuralInvest</appname>
		<appversion>@{app.version}</appversion>
		<authors>
			<author name="Food and Agriculture Organization of the UN" email="TCI-Ruralinvest@fao.org" />
		</authors>
		<javaversion>1.6</javaversion>
		<run-privileged />
		<tempdir/>
		 <!--<pack200/> this works but compilation takes longer -->
	</info>

	<locale>
		<langpack iso3="eng" />
	 	<langpack iso3="fra"/>
		<langpack iso3="spa"/>
		<langpack iso3="bra"/>
		<langpack iso3="rus"/>
		<langpack iso3="tur"/>
	</locale>

	<guiprefs width="800" height="600" resizable="no">
		<splash>images/splash.png</splash>
 		<laf name="kunststoff">
 			<os family="windows" />
 			<os family="unix" />
 		</laf>
		<modifier key="useHeadingPanel" value="yes" />
	</guiprefs>

	<jar src="@{izpack.staging}/custom/izpack-includes.jar" stage="install"/>
	<jar src="@{izpack.staging}/lib/hsqldb.jar" stage="install"/>
	<jar src="@{izpack.staging}/lib/hsqldb18.jar" stage="install"/>
	<jar src="@{izpack.staging}/lib/commons-io.jar" stage="install"/>
	
	<resources>
		<res id="LicencePanel.licence" src="resources/Licence.txt"/>
		<res id="shortcutSpec.xml" src="resources/shortcutSpec.xml"/>
		<res id="ProcessPanel.Spec.xml" src="resources/processPanelSpec.xml"/>
		<res id="userInputSpec.xml" src="resources/userInputSpec.xml"/>
		<res id="Installer.image" src="images/company_logo.gif" />
		<res src="images/langselect.png" id="installer.langsel.img"/>
		<!-- <res id="customicons.xml" src="resources/customicons.xml"/>
		<res id="JFrameIcon.png" src="icons/riv16x16.ico"/> -->
		
		<!-- InfoPanel (readme.txt) -->
		<res id="HTMLInfoPanel.info_eng" src="resources/lang/Readme_eng.html" />
		<res id="HTMLInfoPanel.info_fra" src="resources/lang/Readme_fra.html" />
		<res id="HTMLInfoPanel.info_bra" src="resources/lang/Readme_bra.html" />
		<res id="HTMLInfoPanel.info_rus" src="resources/lang/Readme_rus.html" />
		<res id="HTMLInfoPanel.info_spa" src="resources/lang/Readme_spa.html" />
		<res id="HTMLInfoPanel.info_tur" src="resources/lang/Readme_tur.html" />
		
		<!-- InputPanel -->
		<res id="userInputLang.xml_eng" src="resources/lang/userInputLang.xml_eng" />
		<res id="userInputLang.xml_spa" src="resources/lang/userInputLang.xml_spa" />
		<res id="userInputLang.xml_fra" src="resources/lang/userInputLang.xml_fra" />
		<res id="userInputLang.xml_bra" src="resources/lang/userInputLang.xml_bra" />
		<res id="userInputLang.xml_rus" src="resources/lang/userInputLang.xml_rus" />
		<res id="userInputLang.xml_tur" src="resources/lang/userInputLang.xml_tur" />
		
		<!-- Group selection -->
		<res id="CustomLangPack.xml_eng" src="resources/lang/customLangPack.xml_eng"/>
		<res id="CustomLangPack.xml_fra" src="resources/lang/customLangPack.xml_fra"/>
		<res id="CustomLangPack.xml_bra" src="resources/lang/customLangPack.xml_bra"/>
		<res id="CustomLangPack.xml_rus" src="resources/lang/customLangPack.xml_rus"/>
		<res id="CustomLangPack.xml_spa" src="resources/lang/customLangPack.xml_spa"/>
		<res id="CustomLangPack.xml_tur" src="resources/lang/customLangPack.xml_tur"/>
	</resources>

	<panels>
		<panel classname="HelloPanel" />
		<panel classname="HTMLInfoPanel">
			<actions>
				<action stage="preactivate" classname="org.fao.riv.installer.actions.CollectVariablesAction"/>
				<action stage="preactivate" classname="org.fao.riv.installer.actions.StopWindowsServiceAction" />
				<action stage="preactivate" classname="org.fao.riv.installer.actions.GetJavaHomeAction" />
				<action stage="prevalidate" classname="org.fao.riv.installer.actions.DetermineFreeHttpPortAction"/>
			</actions>
		</panel>
		<panel classname="InstallationGroupPanel" condition="dbExists" />
		<panel classname="DefaultTargetPanel" />
		<panel classname="UserInputPanel" id="panel.newUser" condition="addNewUser"/>
		<panel classname="InstallPanel">
			<actions>
				<action stage="preactivate" classname="org.fao.riv.installer.actions.BackupRiv3Action" />
				<action stage="preactivate" classname="org.fao.riv.installer.actions.BackupExistingRiv4Action" />
				<action stage="preactivate" classname="org.fao.riv.installer.actions.RemoveExistingWebapp"/>
			</actions>
		</panel>
		<panel classname="ProcessPanel"/> 
		<panel classname="ShortcutPanel"/>
		<panel classname="SimpleFinishPanel">
			<actions>
				<action stage="preactivate" classname="org.fao.riv.installer.actions.LaunchUrlAction"/>
			</actions>
		</panel>
	</panels>
	
	<natives>
  		<native type="izpack" name="ShellLink.dll"/>
		<native type="izpack" name="ShellLink_x64.dll"/>
		<native type="3rdparty" name="COIOSHelper.dll" stage="both"/>
		<native type="3rdparty" name="COIOSHelper_x64.dll" stage="both"/>
	</natives>
	
	<listeners>
	    <listener classname="RegistryInstallerListener" stage="install"/>
	    <listener classname="RegistryUninstallerListener" stage="uninstall"/>
	</listeners>	
	
	<conditions>
		<condition type="variable" id="dbExists-old">
			<name>riv3installed</name>
			<value>true</value>
		</condition>
		<condition type="variable" id="dbExists-new">
			<name>riv4installed</name>
			<value>true</value>
		</condition>
		<condition type="or" id="dbExists">
			<condition type="ref" refid="dbExists-old"/>
			<condition type="ref" refid="dbExists-new"/>
		</condition>
		<condition type="variable" id="RIV4-service-exists">
			<name>riv4service</name>
			<value>true</value>
		</condition>
		<condition type="packselection" id="newInstallSelected">
 			<name>NewInstall</name>
		</condition>
		<condition type="packselection" id="upgradeAddsUserSelected">
			<name>UpgradeAddsUser</name>
		</condition>
		<condition type="or" id="addNewUser">
			<condition type="ref" refid="newInstallSelected"/>
			<condition type="ref" refid="upgradeAddsUserSelected"/>
		</condition>
	</conditions>

	<packs>
		<pack name="RuralInvest web application" required="yes" installGroups="NewInstall,Upgrade,UpgradeAddsUser" id="pack.webapp">
			<description>The core files needed for the application</description>
        
        	<fileset dir="@{izpack.staging}/webapp" targetdir="$INSTALL_PATH/webapp" casesensitive="no" override="true">
        	
        	</fileset>
        	<parsable targetfile="$INSTALL_PATH/webapp/WEB-INF/classes/application.properties"/>
			
			<!-- Uninstaller for riv3 -->
			<file src="resources/uninstall-riv3.bat" targetdir="$TEMP_DIRECTORY" override="true" />
			<parsable targetfile="$TEMP_DIRECTORY/uninstall-riv3.bat" />
			
			<!-- shortcuts and their icon -->
			<file src="resources/GuideRuralInvest.url" targetdir="$INSTALL_PATH" override="true" />
			<parsable targetfile="$INSTALL_PATH/GuideRuralInvest.url" />
			<file src="icons/riv.ico" targetdir="$INSTALL_PATH/icons" override="true" />
			
			<file src="resources/startService.bat" targetdir="$TEMP_DIRECTORY" override="true" />
			<!-- removes the Windows service during uninstall  -->
			<file src="resources/removeService.bat" targetdir="$INSTALL_PATH" override="true" />
			<parsable targetfile="$INSTALL_PATH/removeService.bat" />
			<executable targetfile="$INSTALL_PATH/removeService.bat" keep="true" os="windows" stage="uninstall" />
		</pack>
		
		<pack name="Web server launcher" required="yes" condition="!RIV4-service-exists" installGroups="NewInstall,Upgrade,UpgradeAddsUser" id="pack.webserver">
			<description>Service to run embedded web server</description>
			<!--  actual service launcher -->
			<file src="@{izpack.staging}/lib/RIV4-service.jar" targetdir="$INSTALL_PATH/service" override="true" />
			<!--  tool to create windows service -->
			<file src="resources/prunsrv.exe" targetdir="$INSTALL_PATH/service" override="true" />
			<!-- opens port during installation -->
			<file src="resources/openPort.bat" targetdir="$TEMP_DIRECTORY" override="true" />
			<parsable targetfile="$TEMP_DIRECTORY/openPort.bat" />
			<!--  creates the service during installation -->
			<file src="resources/createService.bat" targetdir="$TEMP_DIRECTORY" override="true" />
			<parsable targetfile="$TEMP_DIRECTORY/createService.bat" />
			<!-- shortcut to service -->
			<file src="resources/RuralInvest.url" targetdir="$INSTALL_PATH/service" override="true" />
			<parsable targetfile="$INSTALL_PATH/service/RuralInvest.url" />
			<file src="resources/launchUrl.bat" targetdir="$INSTALL_PATH/service" override="true" />
			<parsable targetfile="$INSTALL_PATH/service/launchUrl.bat" />
		</pack>
 
		<pack name="NewInstall" required="yes" installGroups="NewInstall" id="pack.newDb">
			<description>Installs a blank database</description>
			<fileset dir="@{izpack.staging}/webapp/WEB-INF/data" targetdir="$INSTALL_PATH/webapp/WEB-INF/data" casesensitive="no" override="true" />
		</pack>
		
		<pack name="Upgrade" required="yes" installGroups="Upgrade,UpgradeAddsUser" id="pack.upgrade">
			<description>Update existing RuralInvest database</description>
			<file src="resources/sql.xml" targetdir="$TEMP_DIRECTORY" override="true" />
		</pack>
		<pack name="UpgradeAddsUser" required="yes" installGroups="UpgradeAddsUser" id="pack.upgradeAddsUser">
			<description>Update existing RuralInvest database and add a new user</description>
		</pack>
	</packs>
</installation>
